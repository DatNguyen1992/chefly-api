{"version":3,"file":"email.controller.js","sourceRoot":"","sources":["../../src/email/email.controller.ts"],"names":[],"mappings":"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","sourcesContent":["import {\r\n  Controller,\r\n  Get,\r\n  Post,\r\n  Delete,\r\n  Param,\r\n  Body,\r\n  BadRequestException,\r\n} from '@nestjs/common';\r\nimport { EmailService } from './email.service';\r\nimport { ApiTags } from '@nestjs/swagger';\r\nimport * as crypto from 'crypto';\r\n\r\n@ApiTags('email')\r\n@Controller('email')\r\nexport class EmailController {\r\n  constructor(private readonly emailService: EmailService) {}\r\n\r\n  @Post('generate')\r\n  async generateEmail() {\r\n    return { email: await this.emailService.generateEmail() };\r\n  }\r\n\r\n  @Get(':email/messages')\r\n  async getMessages(@Param('email') email: string) {\r\n    return await this.emailService.getMessages(email);\r\n  }\r\n\r\n  @Get(':email/messages/:messageId')\r\n  async getMessage(\r\n    @Param('email') email: string,\r\n    @Param('messageId') messageId: string,\r\n  ) {\r\n    return await this.emailService.getMessage(email, messageId);\r\n  }\r\n\r\n  @Post(':email/extend')\r\n  async extendEmail(@Param('email') email: string) {\r\n    await this.emailService.extendEmail(email);\r\n    return { message: 'Email extended' };\r\n  }\r\n\r\n  @Delete(':email')\r\n  async deleteEmail(@Param('email') email: string) {\r\n    await this.emailService.deleteEmail(email);\r\n    return { message: 'Email deleted' };\r\n  }\r\n\r\n  @Post('webhook')\r\n  async handleWebhook(@Body() body: any) {\r\n    try {\r\n      // Kiểm tra body có tồn tại và hợp lệ\r\n      if (!body || typeof body !== 'object') {\r\n        throw new BadRequestException('Invalid webhook payload');\r\n      }\r\n\r\n      // Kiểm tra signature\r\n      if (\r\n        !body.signature ||\r\n        !body.signature.timestamp ||\r\n        !body.signature.token ||\r\n        !body.signature.signature\r\n      ) {\r\n        throw new BadRequestException('Missing or invalid signature');\r\n      }\r\n\r\n      // Xác minh chữ ký Mailgun\r\n      const apiKey = '943400ecf659fd87022197efa4bd1a24-17c877d7-a972715e';\r\n      const signature = body.signature;\r\n      console.log('Signature:', signature);\r\n      const data = `${signature.timestamp}${signature.token}`;\r\n      const hmac = crypto\r\n        .createHmac('sha256', apiKey)\r\n        .update(data)\r\n        .digest('hex');\r\n\r\n      if (hmac !== signature.signature) {\r\n        throw new BadRequestException('Invalid webhook signature');\r\n      }\r\n\r\n      // Kiểm tra các trường cần thiết\r\n      const { recipient, sender, subject, 'stripped-text': content } = body;\r\n      if (!recipient || !sender || !subject) {\r\n        throw new BadRequestException(\r\n          'Missing required fields: recipient, sender, or subject',\r\n        );\r\n      }\r\n\r\n      // Lưu email\r\n      await this.emailService.receiveEmail(recipient, {\r\n        from: sender,\r\n        subject,\r\n        content: content || '',\r\n      });\r\n\r\n      return { status: 'received' };\r\n    } catch (error) {\r\n      console.error('Webhook error:', error);\r\n      throw error; // Ném lỗi để client nhận được chi tiết\r\n    }\r\n  }\r\n}\r\n"]}